import { inject, Injectable, InjectionToken } from '@angular/core';
import * as THREE from 'three';
import { Raycaster } from 'three';
import * as i0 from "@angular/core";
export const RAYCASTER = new InjectionToken('A reference to the raycaster object', {
    factory: () => new Raycaster(),
});
export class RaycasterService {
    static { this.instanceCnt = 0; }
    constructor() {
        this.raycaster = inject(RAYCASTER);
        this.selected = null;
        this.enabled = true;
        this.groups = [];
        this.paused = false;
        this.maxClickDistance = 23;
        this.nid = RaycasterService.instanceCnt++;
        this.onPointerMove = this.onPointerMove.bind(this);
        this.onPointerDown = this.onPointerDown.bind(this);
        this.onPointerUp = this.onPointerUp.bind(this);
    }
    ngOnDestroy() {
        this.disable();
        this.unsubscribe();
    }
    subscribe() {
        if (!this.canvas) {
            throw new Error('missing canvas');
        }
        this.canvas.addEventListener('pointermove', this.onPointerMove);
        this.canvas.addEventListener('pointerdown', this.onPointerDown);
        this.canvas.addEventListener('pointerup', this.onPointerUp);
    }
    unsubscribe() {
        if (!this.canvas) {
            throw new Error('missing canvas');
        }
        this.canvas.removeEventListener('pointermove', this.onPointerMove);
        this.canvas.removeEventListener('pointerdown', this.onPointerDown);
        this.canvas.removeEventListener('pointerup', this.onPointerUp);
    }
    enable() {
        this.enabled = true;
    }
    disable() {
        this.enabled = false;
    }
    pause() {
        this.paused = true;
    }
    resume() {
        this.paused = false;
    }
    get isEnabled() {
        return this.enabled;
    }
    init(camera, canvas) {
        // console.log('Add camera to raycaster', camera);
        this.camera = camera;
        this.canvas = canvas;
        this.subscribe();
    }
    addEventTarget(target) {
        // console.log('RaycasterService.addGroup', group.name, group);
        this.groups.push(target);
    }
    removeEventTarget(target) {
        const index = this.groups.indexOf(target);
        if (index >= 0) {
            this.groups.splice(index, 1);
        }
    }
    onPointerMove(event /*MouseEvent  & { layerX: number, layerY: number}*/) {
        if (!this.isReady()) {
            return;
        }
        const i = this.getFirstIntersectedGroup(event.layerX, event.layerY, "mouseEnter" /* RaycasterEvent.mouseEnter */);
        if (!this.selected || this.selected !== i?.target) {
            if (this.selected) {
                this.selected.host.objRef?.dispatchEvent({
                    type: "mouseExit" /* RaycasterEvent.mouseExit */,
                    component: this.selected.host,
                });
                this.selected.emitOnMouseExit();
                this.selected = null;
            }
            if (i && i.target) {
                this.selected = i.target;
                const evt = {
                    type: "mouseEnter" /* RaycasterEvent.mouseEnter */,
                    component: i.target.host,
                    ...i,
                };
                this.selected.host.objRef?.dispatchEvent(evt);
                this.selected.emitOnMouseEnter(evt);
            }
        }
    }
    onPointerDown(event) {
        this.maxClickDistance = event.width;
        this.pointerDownEvent = event;
        if (!this.isReady()) {
            return;
        }
        const i = this.getFirstIntersectedGroup(event.layerX, event.layerY, "pointerDown" /* RaycasterEvent.pointerDown */);
        if (i && i.target && i.target.host.objRef) {
            const evt = { type: "pointerDown" /* RaycasterEvent.pointerDown */, component: i.target.host, ...i };
            i.target.host.objRef.dispatchEvent(evt);
            i.target.emitOnPointerDown(evt);
        }
    }
    onPointerUp(event) {
        const downEvent = this.pointerDownEvent;
        this.pointerDownEvent = undefined;
        if (!this.isReady()) {
            return;
        }
        // pointer up
        let i = this.getFirstIntersectedGroup(event.layerX, event.layerY, "pointerUp" /* RaycasterEvent.pointerUp */);
        if (i && i.target && i.target.host.objRef) {
            const evt = { type: "pointerUp" /* RaycasterEvent.pointerUp */, component: i.target.host, ...i };
            i.target.host.objRef.dispatchEvent(evt);
            i.target.emitOnPointerUp(evt);
        }
        // click
        if (this.calcPointerDownUpDinstance(event, downEvent) > this.maxClickDistance) {
            return;
        }
        i = this.getFirstIntersectedGroup(event.layerX, event.layerY, "click" /* RaycasterEvent.click */);
        if (i && i.target && i.target.host.objRef) {
            const evt = { type: "click" /* RaycasterEvent.click */, component: i.target.host, ...i };
            i.target.host.objRef.dispatchEvent(evt);
            i.target.emitOnClick(evt);
        }
    }
    isReady(ignorePaused) {
        return !!(this.enabled &&
            (ignorePaused || !this.paused) &&
            this.camera &&
            this.camera.objRef &&
            this.groups &&
            this.groups.length > 0);
    }
    calcPointerDownUpDinstance(upEvent, downEvent) {
        if (!downEvent) {
            return Number.MAX_VALUE;
        }
        const xDist = upEvent.layerX - downEvent.layerX;
        const yDist = upEvent.layerY - downEvent.layerY;
        return Math.sqrt(xDist * xDist + yDist * yDist);
    }
    getFirstIntersectedGroup(x, y, event) {
        if (!this.camera || !this.canvas || !this.camera.objRef) {
            return;
        }
        x = (x / this.canvas.clientWidth) * 2 - 1;
        y = -(y / this.canvas.clientHeight) * 2 + 1;
        const mouseVector = new THREE.Vector2(x, y);
        this.raycaster.setFromCamera(mouseVector, this.camera.objRef);
        // loop across all groups. Try to find the group with nearest distance.
        let nearestIntersection;
        let nearestGroup;
        for (const group of this.groups) {
            const i = group.host.objRef;
            if (!group[event] || !i) {
                continue;
            }
            const intersection = this.raycaster.intersectObject(i, true);
            if (intersection.length > 0 &&
                (!nearestIntersection || nearestIntersection.distance > intersection[0].distance)) {
                nearestIntersection = intersection[0];
                nearestGroup = group;
            }
        }
        // return the group with nearest distance
        if (nearestGroup && nearestIntersection) {
            return {
                target: nearestGroup,
                ...nearestIntersection,
            };
        }
        else {
            return undefined;
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.1.2", ngImport: i0, type: RaycasterService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.1.2", ngImport: i0, type: RaycasterService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.1.2", ngImport: i0, type: RaycasterService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmF5Y2FzdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtdGhyZWUvc3JjL2xpYi9ldmVudHMvcmF5Y2FzdGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQzlFLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sRUFBZ0IsU0FBUyxFQUFFLE1BQU0sT0FBTyxDQUFDOztBQXNCaEQsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLElBQUksY0FBYyxDQUFZLHFDQUFxQyxFQUFFO0lBQzVGLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLFNBQVMsRUFBRTtDQUMvQixDQUFDLENBQUM7QUFPSCxNQUFNLE9BQU8sZ0JBQWdCO2FBV1osZ0JBQVcsR0FBRyxDQUFDLEFBQUosQ0FBSztJQVMvQjtRQWxCUSxjQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzlCLGFBQVEsR0FBbUMsSUFBSSxDQUFDO1FBQ2hELFlBQU8sR0FBRyxJQUFJLENBQUM7UUFFZixXQUFNLEdBQW1DLEVBQUUsQ0FBQztRQUM1QyxXQUFNLEdBQUcsS0FBSyxDQUFDO1FBRWYscUJBQWdCLEdBQUcsRUFBRSxDQUFDO1FBU2QsUUFBRyxHQUFHLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBR25ELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElB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UztZQUNYLENBQUM7WUFDRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDN0QsSUFDRSxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUM7Z0JBQ3ZCLENBQUMsQ0FBQyxtQkFBbUIsSUFBSSxtQkFBbUIsQ0FBQyxRQUFRLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUNqRixDQUFDO2dCQUNELG1CQUFtQixHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEMsWUFBWSxHQUFHLEtBQUssQ0FBQztZQUN2QixDQUFDO1FBQ0gsQ0FBQztRQUVELHlDQUF5QztRQUN6QyxJQUFJLFlBQVksSUFBSSxtQkFBbUIsRUFBRSxDQUFDO1lBQ3hDLE9BQU87Z0JBQ0wsTUFBTSxFQUFFLFlBQVk7Z0JBQ3BCLEdBQUcsbUJBQW1CO2FBQ3ZCLENBQUM7UUFDSixDQUFDO2FBQU0sQ0FBQztZQUNOLE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUM7SUFDSCxDQUFDOzhHQTNOVSxnQkFBZ0I7a0hBQWhCLGdCQUFnQjs7MkZBQWhCLGdCQUFnQjtrQkFENUIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnO1xuaW1wb3J0IHsgSW50ZXJzZWN0aW9uLCBSYXljYXN0ZXIgfSBmcm9tICd0aHJlZSc7XG5pbXBvcnQgeyBUaENhbWVyYSB9IGZyb20gJy4uL2dlbmVyYXRlZC9UaENhbWVyYSc7XG5pbXBvcnQgeyBSYXljYXN0ZXJFdmVudERpcmVjdGl2ZSB9IGZyb20gJy4vcmF5Y2FzdGVyLmV2ZW50cy5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgVGhPYmplY3QzRCB9IGZyb20gJy4uL2dlbmVyYXRlZCc7XG5cbmV4cG9ydCBjb25zdCBlbnVtIFJheWNhc3RlckV2ZW50IHtcbiAgbW91c2VFbnRlciA9ICdtb3VzZUVudGVyJyxcbiAgbW91c2VFeGl0ID0gJ21vdXNlRXhpdCcsXG4gIGNsaWNrID0gJ2NsaWNrJyxcbiAgcG9pbnRlckRvd24gPSAncG9pbnRlckRvd24nLFxuICBwb2ludGVyVXAgPSAncG9pbnRlclVwJyxcbn1cblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXNoYWRvd1xuZXhwb3J0IGludGVyZmFjZSBSYXljYXN0ZXJFdmVudE1hcCB7XG4gIG1vdXNlRW50ZXI6IHsgY29tcG9uZW50OiBUaE9iamVjdDNEPFRIUkVFLk9iamVjdDNERXZlbnRNYXAgJiBSYXljYXN0ZXJFdmVudE1hcD4gfTtcbiAgbW91c2VFeGl0OiB7IGNvbXBvbmVudDogVGhPYmplY3QzRDxUSFJFRS5PYmplY3QzREV2ZW50TWFwICYgUmF5Y2FzdGVyRXZlbnRNYXA+IH07XG4gIGNsaWNrOiB7IGNvbXBvbmVudDogVGhPYmplY3QzRDxUSFJFRS5PYmplY3QzREV2ZW50TWFwICYgUmF5Y2FzdGVyRXZlbnRNYXA+IH07XG4gIHBvaW50ZXJEb3duOiB7IGNvbXBvbmVudDogVGhPYmplY3QzRDxUSFJFRS5PYmplY3QzREV2ZW50TWFwICYgUmF5Y2FzdGVyRXZlbnRNYXA+IH07XG4gIHBvaW50ZXJVcDogeyBjb21wb25lbnQ6IFRoT2JqZWN0M0Q8VEhSRUUuT2JqZWN0M0RFdmVudE1hcCAmIFJheWNhc3RlckV2ZW50TWFwPiB9O1xufVxuXG5leHBvcnQgY29uc3QgUkFZQ0FTVEVSID0gbmV3IEluamVjdGlvblRva2VuPFJheWNhc3Rlcj4oJ0EgcmVmZXJlbmNlIHRvIHRoZSByYXljYXN0ZXIgb2JqZWN0Jywge1xuICBmYWN0b3J5OiAoKSA9PiBuZXcgUmF5Y2FzdGVyKCksXG59KTtcblxuaW50ZXJmYWNlIE5lYXJlc3RJbnRlcnNlY3Rpb24gZXh0ZW5kcyBJbnRlcnNlY3Rpb24ge1xuICB0YXJnZXQ/OiBSYXljYXN0ZXJFdmVudERpcmVjdGl2ZSB8IG51bGw7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSYXljYXN0ZXJTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBjYW52YXM/OiBIVE1MRWxlbWVudDtcbiAgcHJpdmF0ZSByYXljYXN0ZXIgPSBpbmplY3QoUkFZQ0FTVEVSKTtcbiAgcHJpdmF0ZSBzZWxlY3RlZDogUmF5Y2FzdGVyRXZlbnREaXJlY3RpdmUgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBlbmFibGVkID0gdHJ1ZTtcbiAgcHJpdmF0ZSBjYW1lcmE/OiBUaENhbWVyYTtcbiAgcHJpdmF0ZSBncm91cHM6IEFycmF5PFJheWNhc3RlckV2ZW50RGlyZWN0aXZlPiA9IFtdO1xuICBwcml2YXRlIHBhdXNlZCA9IGZhbHNlO1xuXG4gIHByaXZhdGUgbWF4Q2xpY2tEaXN0YW5jZSA9IDIzO1xuXG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlQ250ID0gMDtcblxuICAvKipcbiAgICogdGFyZ2V0cyBvZiB0aGUgcG9pbnRlciBkb3duIGV2ZW50XG4gICAqL1xuICBwcml2YXRlIHBvaW50ZXJEb3duRXZlbnQ/OiBQb2ludGVyRXZlbnQ7XG5cbiAgcHVibGljIHJlYWRvbmx5IG5pZCA9IFJheWNhc3RlclNlcnZpY2UuaW5zdGFuY2VDbnQrKztcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLm9uUG9pbnRlck1vdmUgPSB0aGlzLm9uUG9pbnRlck1vdmUuYmluZCh0aGlzKTtcbiAgICB0aGlzLm9uUG9pbnRlckRvd24gPSB0aGlzLm9uUG9pbnRlckRvd24uYmluZCh0aGlzKTtcbiAgICB0aGlzLm9uUG9pbnRlclVwID0gdGhpcy5vblBvaW50ZXJVcC5iaW5kKHRoaXMpO1xuICB9XG5cbiAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZGlzYWJsZSgpO1xuICAgIHRoaXMudW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaWJlKCkge1xuICAgIGlmICghdGhpcy5jYW52YXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbWlzc2luZyBjYW52YXMnKTtcbiAgICB9XG4gICAgdGhpcy5jYW52YXMuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcm1vdmUnLCB0aGlzLm9uUG9pbnRlck1vdmUpO1xuICAgIHRoaXMuY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgdGhpcy5vblBvaW50ZXJEb3duKTtcbiAgICB0aGlzLmNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVydXAnLCB0aGlzLm9uUG9pbnRlclVwKTtcbiAgfVxuXG4gIHByaXZhdGUgdW5zdWJzY3JpYmUoKSB7XG4gICAgaWYgKCF0aGlzLmNhbnZhcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdtaXNzaW5nIGNhbnZhcycpO1xuICAgIH1cbiAgICB0aGlzLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdwb2ludGVybW92ZScsIHRoaXMub25Qb2ludGVyTW92ZSk7XG4gICAgdGhpcy5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nLCB0aGlzLm9uUG9pbnRlckRvd24pO1xuICAgIHRoaXMuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJ1cCcsIHRoaXMub25Qb2ludGVyVXApO1xuICB9XG5cbiAgcHVibGljIGVuYWJsZSgpIHtcbiAgICB0aGlzLmVuYWJsZWQgPSB0cnVlO1xuICB9XG5cbiAgcHVibGljIGRpc2FibGUoKSB7XG4gICAgdGhpcy5lbmFibGVkID0gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgcGF1c2UoKSB7XG4gICAgdGhpcy5wYXVzZWQgPSB0cnVlO1xuICB9XG5cbiAgcHVibGljIHJlc3VtZSgpIHtcbiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlO1xuICB9XG5cbiAgZ2V0IGlzRW5hYmxlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5lbmFibGVkO1xuICB9XG5cbiAgcHVibGljIGluaXQoY2FtZXJhOiBUaENhbWVyYSwgY2FudmFzOiBIVE1MRWxlbWVudCkge1xuICAgIC8vIGNvbnNvbGUubG9nKCdBZGQgY2FtZXJhIHRvIHJheWNhc3RlcicsIGNhbWVyYSk7XG4gICAgdGhpcy5jYW1lcmEgPSBjYW1lcmE7XG4gICAgdGhpcy5jYW52YXMgPSBjYW52YXM7XG4gICAgdGhpcy5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRFdmVudFRhcmdldCh0YXJnZXQ6IFJheWNhc3RlckV2ZW50RGlyZWN0aXZlKSB7XG4gICAgLy8gY29uc29sZS5sb2coJ1JheWNhc3RlclNlcnZpY2UuYWRkR3JvdXAnLCBncm91cC5uYW1lLCBncm91cCk7XG4gICAgdGhpcy5ncm91cHMucHVzaCh0YXJnZXQpO1xuICB9XG5cbiAgcHVibGljIHJlbW92ZUV2ZW50VGFyZ2V0KHRhcmdldDogUmF5Y2FzdGVyRXZlbnREaXJlY3RpdmUpIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ3JvdXBzLmluZGV4T2YodGFyZ2V0KTtcbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgdGhpcy5ncm91cHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uUG9pbnRlck1vdmUoZXZlbnQ6IGFueSAvKk1vdXNlRXZlbnQgICYgeyBsYXllclg6IG51bWJlciwgbGF5ZXJZOiBudW1iZXJ9Ki8pIHtcbiAgICBpZiAoIXRoaXMuaXNSZWFkeSgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGkgPSB0aGlzLmdldEZpcnN0SW50ZXJzZWN0ZWRHcm91cChldmVudC5sYXllclgsIGV2ZW50LmxheWVyWSwgUmF5Y2FzdGVyRXZlbnQubW91c2VFbnRlcik7XG4gICAgaWYgKCF0aGlzLnNlbGVjdGVkIHx8IHRoaXMuc2VsZWN0ZWQgIT09IGk/LnRhcmdldCkge1xuICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZC5ob3N0Lm9ialJlZj8uZGlzcGF0Y2hFdmVudCh7XG4gICAgICAgICAgdHlwZTogUmF5Y2FzdGVyRXZlbnQubW91c2VFeGl0LFxuICAgICAgICAgIGNvbXBvbmVudDogdGhpcy5zZWxlY3RlZC5ob3N0LFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZC5lbWl0T25Nb3VzZUV4aXQoKTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZCA9IG51bGw7XG4gICAgICB9XG4gICAgICBpZiAoaSAmJiBpLnRhcmdldCkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkID0gaS50YXJnZXQ7XG4gICAgICAgIGNvbnN0IGV2dCA9IHtcbiAgICAgICAgICB0eXBlOiBSYXljYXN0ZXJFdmVudC5tb3VzZUVudGVyLFxuICAgICAgICAgIGNvbXBvbmVudDogaS50YXJnZXQuaG9zdCxcbiAgICAgICAgICAuLi5pLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNlbGVjdGVkLmhvc3Qub2JqUmVmPy5kaXNwYXRjaEV2ZW50KGV2dCk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWQuZW1pdE9uTW91c2VFbnRlcihldnQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25Qb2ludGVyRG93bihldmVudDogUG9pbnRlckV2ZW50KSB7XG4gICAgdGhpcy5tYXhDbGlja0Rpc3RhbmNlID0gZXZlbnQud2lkdGg7XG4gICAgdGhpcy5wb2ludGVyRG93bkV2ZW50ID0gZXZlbnQ7XG5cbiAgICBpZiAoIXRoaXMuaXNSZWFkeSgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaSA9IHRoaXMuZ2V0Rmlyc3RJbnRlcnNlY3RlZEdyb3VwKChldmVudCBhcyBhbnkpLmxheWVyWCwgKGV2ZW50IGFzIGFueSkubGF5ZXJZLCBSYXljYXN0ZXJFdmVudC5wb2ludGVyRG93bik7XG4gICAgaWYgKGkgJiYgaS50YXJnZXQgJiYgaS50YXJnZXQuaG9zdC5vYmpSZWYpIHtcbiAgICAgIGNvbnN0IGV2dCA9IHsgdHlwZTogUmF5Y2FzdGVyRXZlbnQucG9pbnRlckRvd24sIGNvbXBvbmVudDogaS50YXJnZXQuaG9zdCwgLi4uaSB9O1xuICAgICAgaS50YXJnZXQuaG9zdC5vYmpSZWYuZGlzcGF0Y2hFdmVudChldnQpO1xuICAgICAgaS50YXJnZXQuZW1pdE9uUG9pbnRlckRvd24oZXZ0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uUG9pbnRlclVwKGV2ZW50OiBQb2ludGVyRXZlbnQpIHtcbiAgICBjb25zdCBkb3duRXZlbnQgPSB0aGlzLnBvaW50ZXJEb3duRXZlbnQ7XG4gICAgdGhpcy5wb2ludGVyRG93bkV2ZW50ID0gdW5kZWZpbmVkO1xuXG4gICAgaWYgKCF0aGlzLmlzUmVhZHkoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHBvaW50ZXIgdXBcbiAgICBsZXQgaSA9IHRoaXMuZ2V0Rmlyc3RJbnRlcnNlY3RlZEdyb3VwKChldmVudCBhcyBhbnkpLmxheWVyWCwgKGV2ZW50IGFzIGFueSkubGF5ZXJZLCBSYXljYXN0ZXJFdmVudC5wb2ludGVyVXApO1xuICAgIGlmIChpICYmIGkudGFyZ2V0ICYmIGkudGFyZ2V0Lmhvc3Qub2JqUmVmKSB7XG4gICAgICBjb25zdCBldnQgPSB7IHR5cGU6IFJheWNhc3RlckV2ZW50LnBvaW50ZXJVcCwgY29tcG9uZW50OiBpLnRhcmdldC5ob3N0LCAuLi5pIH07XG4gICAgICBpLnRhcmdldC5ob3N0Lm9ialJlZi5kaXNwYXRjaEV2ZW50KGV2dCk7XG4gICAgICBpLnRhcmdldC5lbWl0T25Qb2ludGVyVXAoZXZ0KTtcbiAgICB9XG5cbiAgICAvLyBjbGlja1xuICAgIGlmICh0aGlzLmNhbGNQb2ludGVyRG93blVwRGluc3RhbmNlKGV2ZW50LCBkb3duRXZlbnQpID4gdGhpcy5tYXhDbGlja0Rpc3RhbmNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGkgPSB0aGlzLmdldEZpcnN0SW50ZXJzZWN0ZWRHcm91cCgoZXZlbnQgYXMgYW55KS5sYXllclgsIChldmVudCBhcyBhbnkpLmxheWVyWSwgUmF5Y2FzdGVyRXZlbnQuY2xpY2spO1xuICAgIGlmIChpICYmIGkudGFyZ2V0ICYmIGkudGFyZ2V0Lmhvc3Qub2JqUmVmKSB7XG4gICAgICBjb25zdCBldnQgPSB7IHR5cGU6IFJheWNhc3RlckV2ZW50LmNsaWNrLCBjb21wb25lbnQ6IGkudGFyZ2V0Lmhvc3QsIC4uLmkgfTtcbiAgICAgIGkudGFyZ2V0Lmhvc3Qub2JqUmVmLmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgICAgIGkudGFyZ2V0LmVtaXRPbkNsaWNrKGV2dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc1JlYWR5KGlnbm9yZVBhdXNlZD86IGJvb2xlYW4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gISEoXG4gICAgICB0aGlzLmVuYWJsZWQgJiZcbiAgICAgIChpZ25vcmVQYXVzZWQgfHwgIXRoaXMucGF1c2VkKSAmJlxuICAgICAgdGhpcy5jYW1lcmEgJiZcbiAgICAgIHRoaXMuY2FtZXJhLm9ialJlZiAmJlxuICAgICAgdGhpcy5ncm91cHMgJiZcbiAgICAgIHRoaXMuZ3JvdXBzLmxlbmd0aCA+IDBcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjUG9pbnRlckRvd25VcERpbnN0YW5jZSh1cEV2ZW50OiBQb2ludGVyRXZlbnQsIGRvd25FdmVudD86IFBvaW50ZXJFdmVudCkge1xuICAgIGlmICghZG93bkV2ZW50KSB7XG4gICAgICByZXR1cm4gTnVtYmVyLk1BWF9WQUxVRTtcbiAgICB9XG4gICAgY29uc3QgeERpc3QgPSAodXBFdmVudCBhcyBhbnkpLmxheWVyWCAtIChkb3duRXZlbnQgYXMgYW55KS5sYXllclg7XG4gICAgY29uc3QgeURpc3QgPSAodXBFdmVudCBhcyBhbnkpLmxheWVyWSAtIChkb3duRXZlbnQgYXMgYW55KS5sYXllclk7XG4gICAgcmV0dXJuIE1hdGguc3FydCh4RGlzdCAqIHhEaXN0ICsgeURpc3QgKiB5RGlzdCk7XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0SW50ZXJzZWN0ZWRHcm91cChcbiAgICB4OiBudW1iZXIsXG4gICAgeTogbnVtYmVyLFxuICAgIGV2ZW50OiBrZXlvZiBSYXljYXN0ZXJFdmVudE1hcCxcbiAgKTogTmVhcmVzdEludGVyc2VjdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCF0aGlzLmNhbWVyYSB8fCAhdGhpcy5jYW52YXMgfHwgIXRoaXMuY2FtZXJhLm9ialJlZikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB4ID0gKHggLyB0aGlzLmNhbnZhcy5jbGllbnRXaWR0aCkgKiAyIC0gMTtcbiAgICB5ID0gLSh5IC8gdGhpcy5jYW52YXMuY2xpZW50SGVpZ2h0KSAqIDIgKyAxO1xuICAgIGNvbnN0IG1vdXNlVmVjdG9yID0gbmV3IFRIUkVFLlZlY3RvcjIoeCwgeSk7XG4gICAgdGhpcy5yYXljYXN0ZXIuc2V0RnJvbUNhbWVyYShtb3VzZVZlY3RvciwgdGhpcy5jYW1lcmEub2JqUmVmKTtcblxuICAgIC8vIGxvb3AgYWNyb3NzIGFsbCBncm91cHMuIFRyeSB0byBmaW5kIHRoZSBncm91cCB3aXRoIG5lYXJlc3QgZGlzdGFuY2UuXG4gICAgbGV0IG5lYXJlc3RJbnRlcnNlY3Rpb246IFRIUkVFLkludGVyc2VjdGlvbiB8IHVuZGVmaW5lZDtcbiAgICBsZXQgbmVhcmVzdEdyb3VwOiBSYXljYXN0ZXJFdmVudERpcmVjdGl2ZSB8IHVuZGVmaW5lZDtcbiAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIHRoaXMuZ3JvdXBzKSB7XG4gICAgICBjb25zdCBpID0gZ3JvdXAuaG9zdC5vYmpSZWY7XG4gICAgICBpZiAoIWdyb3VwW2V2ZW50XSB8fCAhaSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMucmF5Y2FzdGVyLmludGVyc2VjdE9iamVjdChpLCB0cnVlKTtcbiAgICAgIGlmIChcbiAgICAgICAgaW50ZXJzZWN0aW9uLmxlbmd0aCA+IDAgJiZcbiAgICAgICAgKCFuZWFyZXN0SW50ZXJzZWN0aW9uIHx8IG5lYXJlc3RJbnRlcnNlY3Rpb24uZGlzdGFuY2UgPiBpbnRlcnNlY3Rpb25bMF0uZGlzdGFuY2UpXG4gICAgICApIHtcbiAgICAgICAgbmVhcmVzdEludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvblswXTtcbiAgICAgICAgbmVhcmVzdEdyb3VwID0gZ3JvdXA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIHRoZSBncm91cCB3aXRoIG5lYXJlc3QgZGlzdGFuY2VcbiAgICBpZiAobmVhcmVzdEdyb3VwICYmIG5lYXJlc3RJbnRlcnNlY3Rpb24pIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRhcmdldDogbmVhcmVzdEdyb3VwLFxuICAgICAgICAuLi5uZWFyZXN0SW50ZXJzZWN0aW9uLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==